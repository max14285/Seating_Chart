<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿå¿—é¡˜é¸å¡« - ç¬¬äºŒæ®µç¨‹å¼</title>
    <style>
        /* ... CSS æ¨£å¼èˆ‡ä¹‹å‰ç‰ˆæœ¬ç›¸åŒï¼Œç‚ºäº†ç°¡æ½”åœ¨æ­¤çœç•¥ ... */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f7f9; }
        h1 { color: #007bff; text-align: center; }
        .controls { background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); margin-bottom: 20px; display: flex; align-items: center; gap: 20px; }
        .controls label { font-weight: bold; }
        .controls select, .controls button { padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 16px; }
        
        #uploadBtn { background-color: #28a745; color: white; border: none; cursor: pointer; transition: background-color 0.3s; }
        #uploadBtn:hover { background-color: #1e7e34; }
        #clearBtn { background-color: #dc3545; color: white; border: none; cursor: pointer; transition: background-color 0.3s; }
        #clearBtn:hover { background-color: #c82333; }

        .seating-chart-container { display: flex; justify-content: center; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        #seatMap { display: grid; gap: 5px; }
        
        .seat { 
            background-color: #007bff; color: white; font-weight: bold; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            height: 60px; width: 60px; border-radius: 6px; cursor: pointer; 
            transition: background-color 0.3s; border: 3px solid transparent; 
            font-size: 14px;
        }
        .seat.unavailable { background-color: #6c757d; cursor: not-allowed; opacity: 0.7; }
        .seat:not(.unavailable):hover { background-color: #0056b3; border-color: #ffc107; }
        
        .seat-id { font-size: 10px; opacity: 0.8; margin-top: 2px; }
        .rank { font-size: 20px; line-height: 1; }
        .seat.selected { border: 3px solid #ffc107; }
        .note { margin-top: 20px; padding: 10px; background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; border-radius: 5px; font-weight: bold;}
    </style>
</head>
<body>

    <h1>ğŸ“ åº§ä½å¿—é¡˜é¸å¡«</h1>

    <div class="controls">
        <label for="studentSelect">è«‹é¸æ“‡æ‚¨çš„åº§è™Ÿï¼š</label>
        <select id="studentSelect">
            <option value="">-- è«‹é¸æ“‡åº§è™Ÿ --</option>
        </select>
        <button id="clearBtn">æ¸…ç©ºå¿—é¡˜</button>
        <button id="uploadBtn">ä¸Šå‚³å¿—é¡˜ (æäº¤è‡³ Google)</button>
    </div>

    <div class="seating-chart-container">
        <div id="seatMap">è¼‰å…¥ä¸­...</div>
    </div>
    
    <div class="note">
        **æ³¨æ„ï¼š** é»æ“Šä¸Šå‚³å¾Œï¼Œæ‚¨çš„å¿—é¡˜æœƒæäº¤è‡³å¾Œå° Google è©¦ç®—è¡¨ã€‚å¦‚æœæ‚¨éœ€è¦å†æ¬¡å¡«å¯«ï¼Œè«‹é‡æ–°é¸å¡«ä¸¦é»æ“Šä¸Šå‚³ï¼Œæ–°çš„å¿—é¡˜å°‡æœƒè¦†è“‹èˆŠçš„ã€‚
    </div>

    <script>
        const ROW_LETTERS = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
        const studentSelect = document.getElementById('studentSelect');
        const seatMapDiv = document.getElementById('seatMap');
        const clearBtn = document.getElementById('clearBtn');
        const uploadBtn = document.getElementById('uploadBtn');

        let currentSelections = []; 
        let currentStudentId = null;
        let seatingConfig = null;
        let studentData = null;
        
        // **è«‹æ›¿æ›ç‚ºæ‚¨çš„ Google Form è¨­å®šå€¼**
        const FORM_ACTION_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSfuPbctj-TvBmDtauc2pottDQR_NuFIssn9mUrfInG4DRkeKQ/viewform?embedded=true'; 
        const FIELD_STUDENT_ID = 'entry.878919355'; 
        const FIELD_VOLUNTEERS = 'entry.1183865171';

        // ç‚ºäº†åœ¨ selection.html ä¸Šé¡¯ç¤ºå·²é¸ï¼Œæˆ‘å€‘éœ€è¦å…ˆè®€å–ä¸€éå¿—é¡˜ï¼Œä½†ä¸èƒ½ä¿è­‰æ•¸æ“šæœ€æ–°ã€‚
        let volunteerData = {}; 
        const APPS_SCRIPT_API_URL = 'https://script.google.com/macros/s/AKfycbz1qRFp0IC6RAUJvosl-ACMuCRD42S7mFUFZMp_vtsNs7nLLxhBWXtAfHm_E3E4iccOoA/exec'; // èˆ‡ distribution.html å…±ç”¨

        /**
         * è®€å–æ‰€æœ‰æ‰€éœ€çš„æ•¸æ“š (å¾ config.json å’Œ Apps Script è®€å–)
         */
        async function loadData() {
            try {
                // 1. è¼‰å…¥å­¸ç”Ÿåå–® (å¾ LocalStorage è®€å–)
                const studentStr = localStorage.getItem('student_data');
                if (!studentStr) throw new Error('å­¸ç”Ÿåå–®æœªè¼‰å…¥ï¼Œè«‹å…ˆé‹è¡Œ setting.html');
                studentData = JSON.parse(studentStr);

                // 2. å¾ config.json æª”æ¡ˆè¼‰å…¥åº§ä½é…ç½®
                const configResponse = await fetch('config.json');
                if (!configResponse.ok) throw new Error('config.json æª”æ¡ˆä¸å­˜åœ¨ã€‚è«‹å…ˆåœ¨ setting.html å„²å­˜é…ç½®ã€‚');
                seatingConfig = await configResponse.json();

                // 3. å¾ Apps Script JSON API è¼‰å…¥æœ€æ–°å¿—é¡˜çµæœ (ç”¨æ–¼é å…ˆé¡¯ç¤º)
                const volunteerResponse = await fetch(APPS_SCRIPT_API_URL);
                if (!volunteerResponse.ok) console.warn('ç„¡æ³•è®€å–å¿—é¡˜æ•¸æ“šï¼Œå¯èƒ½å°šæœªæœ‰äººæäº¤ã€‚');
                
                if (volunteerResponse.ok) {
                    const apiResult = await volunteerResponse.json(); 
                    volunteerData = apiResult.data || {};
                }
                
                return true;
            } catch (error) {
                console.error('è¼‰å…¥è³‡æ–™éŒ¯èª¤:', error);
                alert(`è¼‰å…¥è³‡æ–™å¤±æ•—ï¼š${error.message}`);
                seatMapDiv.innerHTML = `è¼‰å…¥éŒ¯èª¤ï¼š${error.message}`;
                return false;
            }
        }

        // ... (populateStudentSelect, renderSeatMap, updateSeatRanks, handleSeatClick, clearBtn.addEventListener å‡½æ•¸éƒ½èˆ‡ä¹‹å‰ç‰ˆæœ¬ç›¸åŒï¼Œåœ¨æ­¤çœç•¥)

        /**
         * å¡«å……å­¸ç”Ÿåº§è™Ÿä¸‹æ‹‰å¼é¸å–®
         */
        function populateStudentSelect() {
            if (!studentData) return;
            const sortedKeys = Object.keys(studentData).sort((a, b) => parseInt(a) - parseInt(b));
            sortedKeys.forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = `${id} è™Ÿ - ${studentData[id]}`;
                studentSelect.appendChild(option);
            });
        }
        
        /**
         * æ¸²æŸ“åº§ä½è¡¨
         */
        function renderSeatMap() {
            if (!seatingConfig) return;
            // ... (èˆ‡ä¹‹å‰ç‰ˆæœ¬ç›¸åŒ)
            seatMapDiv.innerHTML = '';
            seatMapDiv.style.gridTemplateColumns = `repeat(${seatingConfig.cols}, auto)`;
            for (let r = 0; r < seatingConfig.rows; r++) {
                for (let c = 1; c <= seatingConfig.cols; c++) {
                    const seatId = `${ROW_LETTERS[r]}${c}`;
                    const seatEl = document.createElement('div');
                    seatEl.classList.add('seat');
                    seatEl.dataset.id = seatId;
                    const rankDiv = document.createElement('div');
                    rankDiv.classList.add('rank');
                    const idDiv = document.createElement('div');
                    idDiv.classList.add('seat-id');
                    idDiv.textContent = seatId; 
                    seatEl.appendChild(rankDiv);
                    seatEl.appendChild(idDiv);
                    if (seatingConfig.unavailable.includes(seatId)) {
                        seatEl.classList.add('unavailable');
                        seatEl.title = 'ä¸å¯é¸åº§ä½';
                        seatMapDiv.appendChild(seatEl);
                        continue; 
                    }
                    seatEl.addEventListener('click', handleSeatClick);
                    seatMapDiv.appendChild(seatEl);
                }
            }
        }
        
        /**
         * æ ¹æ“š currentSelections é‡æ–°ç¹ªè£½å¿—é¡˜åºæ¨™è¨˜
         */
        function updateSeatRanks() {
            document.querySelectorAll('.seat').forEach(seat => {
                const seatId = seat.dataset.id;
                const rankDiv = seat.querySelector('.rank');
                seat.classList.remove('selected');
                rankDiv.textContent = ''; 
                const rankIndex = currentSelections.indexOf(seatId);
                if (rankIndex !== -1) {
                    const rank = rankIndex + 1;
                    rankDiv.textContent = rank;
                    seat.classList.add('selected'); 
                }
            });
        }

        /**
         * è™•ç†åº§ä½é»æ“Šäº‹ä»¶ï¼ˆè¨­å®šå¿—é¡˜åºï¼‰
         */
        function handleSeatClick(event) {
             if (!currentStudentId) {
                alert('è«‹å…ˆåœ¨ä¸Šæ–¹ä¸‹æ‹‰å¼é¸å–®é¸æ“‡æ‚¨çš„åº§è™Ÿï¼');
                return;
            }
            const seatEl = event.currentTarget;
            const seatId = seatEl.dataset.id;
            if (seatEl.classList.contains('unavailable')) return;
            const index = currentSelections.indexOf(seatId);
            if (index === -1) {
                currentSelections.push(seatId);
            } else {
                currentSelections.splice(index, 1);
            }
            updateSeatRanks();
        }

        /**
         * è™•ç†æ¸…ç©ºå¿—é¡˜æŒ‰éˆ•
         */
        clearBtn.addEventListener('click', function() {
            if (!currentStudentId) {
                alert('è«‹å…ˆé¸æ“‡åº§è™Ÿï¼');
                return;
            }
            if (confirm(`ç¢ºå®šè¦æ¸…ç©º ${currentStudentId} è™Ÿçš„å¿—é¡˜å—ï¼Ÿ`)) {
                currentSelections = [];
                updateSeatRanks();
                alert('å¿—é¡˜å·²æ¸…ç©º (å°šæœªä¸Šå‚³å„²å­˜)ï¼');
            }
        });
        
        /**
         * è™•ç†ä¸Šå‚³å¿—é¡˜æŒ‰éˆ• (AJAX æäº¤è‡³ Google Form)
         */
        uploadBtn.addEventListener('click', function() {
            if (!currentStudentId) {
                alert('è«‹å…ˆé¸æ“‡åº§è™Ÿï¼');
                return;
            }
            
            if (currentSelections.length === 0) {
                 if (!confirm(`æ‚¨å°šæœªé¸å¡«ä»»ä½•å¿—é¡˜ï¼Œç¢ºå®šè¦å„²å­˜ç©ºçš„å¿—é¡˜å—ï¼Ÿé€™å°‡è¦†è“‹æ‚¨ä¹‹å‰çš„å¿—é¡˜ç´€éŒ„ã€‚`)) {
                    return;
                }
            }

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'ä¸Šå‚³ä¸­...';
            
            const volunteerString = currentSelections.join(','); // ä¾‹å¦‚: "A1,B2,C3,..."

            // æº–å‚™æäº¤çµ¦ Google Form çš„æ•¸æ“š (URL-encoded)
            const formData = new URLSearchParams();
            formData.append(FIELD_STUDENT_ID, currentStudentId);
            formData.append(FIELD_VOLUNTEERS, volunteerString);

            // ä½¿ç”¨ Fetch API æäº¤æ•¸æ“š
            fetch(FORM_ACTION_URL, {
                method: 'POST',
                mode: 'no-cors', // å¿…é ˆä½¿ç”¨ no-cors æ¨¡å¼ä¾†æäº¤åˆ° Google Forms
                body: formData
            })
            .then(() => {
                // æˆåŠŸæäº¤å¾Œï¼Œæ›´æ–°æœ¬åœ°ç‹€æ…‹ä¸¦æç¤º
                alert(`${currentStudentId} è™Ÿ ( ${studentData[currentStudentId]} ) çš„ ${currentSelections.length} å€‹å¿—é¡˜å·²æäº¤ï¼è«‹åœ¨åˆ†ç™¼é é¢ç¢ºèªæœ€æ–°æ•¸æ“šã€‚`);
                volunteerData[currentStudentId] = currentSelections; // æš«æ™‚æ›´æ–°æœ¬åœ°æ•¸æ“š
            })
            .catch(error => {
                alert('å¿—é¡˜æäº¤å¤±æ•—ï¼è«‹æª¢æŸ¥ç¶²è·¯æˆ– Google Form URL æ˜¯å¦æ­£ç¢ºã€‚');
                console.error('æäº¤éŒ¯èª¤:', error);
            })
            .finally(() => {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'ä¸Šå‚³å¿—é¡˜ (æäº¤è‡³ Google)';
            });
        });


        /**
         * è™•ç†å­¸ç”Ÿåº§è™Ÿé¸æ“‡è®ŠåŒ–
         */
        studentSelect.addEventListener('change', async function() {
            const selectedId = this.value;
            if (selectedId) {
                currentStudentId = selectedId;
                // é‡æ–°è¼‰å…¥æœ€æ–°å¿—é¡˜æ•¸æ“šä»¥é˜²å…¶ä»–å­¸ç”ŸåŒæ™‚æäº¤
                await loadData(); 
                currentSelections = volunteerData[currentStudentId] ? [...volunteerData[currentStudentId]] : [];
            } else {
                currentStudentId = null;
                currentSelections = [];
            }
            
            updateSeatRanks();
        });

        // åˆå§‹åŒ–
        (async function() {
            if (await loadData()) {
                populateStudentSelect();
                renderSeatMap();
            }
        })();
    </script>
</body>
</html>
