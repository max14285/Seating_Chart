<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿå¿—é¡˜é¸å¡«</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f4f7f9; }
        .controls { background: #fff; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
        .seat { width: 60px; height: 60px; background: #007bff; color: white; display: flex; align-items: center; justify-content: center; margin: 2px; border-radius: 4px; cursor: pointer; }
        .seat.unavailable { background: #6c757d; pointer-events: none; }
        .seat.selected { border: 3px solid #ffc107; }
        #seatMap { display: grid; gap: 5px; justify-content: center; }
    </style>
</head>
<body>
    <h1>ğŸ“ å¿—é¡˜é¸å¡«</h1>
    <div class="controls">
        <label>åº§è™Ÿï¼š</label>
        <select id="studentSelect"><option value="">è¼‰å…¥ä¸­...</option></select>
        <button id="clearBtn">æ¸…ç©º</button>
        <button id="uploadBtn">ä¸Šå‚³å¿—é¡˜</button>
    </div>
    <div id="seatMap"></div>

    <script>
        // **********************************************
        // è«‹å¡«å…¥æ‚¨çš„è³‡è¨Š

                // **è«‹æ›¿æ›ç‚ºæ‚¨çš„ Google Form è¨­å®šå€¼**
        const FORM_ACTION_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSfuPbctj-TvBmDtauc2pottDQR_NuFIssn9mUrfInG4DRkeKQ/formResponse'; 
        const FIELD_STUDENT_ID = 'entry.878919355'; 
        const FIELD_VOLUNTEERS = 'entry.1183865171';
        const APPS_SCRIPT_API_URL = 'https://script.google.com/macros/s/AKfycbz1qRFp0IC6RAUJvosl-ACMuCRD42S7mFUFZMp_vtsNs7nLLxhBWXtAfHm_E3E4iccOoA/exec'; // èˆ‡ distribution.html å…±ç”¨
        // **********************************************

        const ROW_LETTERS = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];
        let currentSelections = [];
        let globalData = {}; // å­˜æ”¾å¾ API æŠ“å›ä¾†çš„æ‰€æœ‰è³‡æ–™

        async function init() {
            try {
                const res = await fetch(APPS_SCRIPT_API_URL);
                const json = await res.json();
                globalData = json.data;
                
                if (!globalData.students || !globalData.config) {
                    alert("ç„¡æ³•è®€å–è¨­å®šï¼è«‹ç¢ºèªè€å¸«æ˜¯å¦å·²åœ¨ SystemData åˆ†é è¨­å®šå¥½ A2(åå–®) å’Œ B2(è¦æ ¼)ã€‚");
                    return;
                }

                populateSelect();
                renderMap();
            } catch (e) {
                alert("é€£ç·šéŒ¯èª¤ï¼š" + e.message);
            }
        }

        function populateSelect() {
            const select = document.getElementById('studentSelect');
            select.innerHTML = '<option value="">-- è«‹é¸æ“‡åº§è™Ÿ --</option>';
            // æ’åºåº§è™Ÿ
            Object.keys(globalData.students).sort((a,b)=>a-b).forEach(id => {
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = `${id}è™Ÿ - ${globalData.students[id]}`;
                select.appendChild(opt);
            });
            
            // ç•¶é¸æ“‡æ”¹è®Šæ™‚
            select.addEventListener('change', function() {
                const sid = this.value;
                currentSelections = [];
                if (sid && globalData.volunteers[sid]) {
                    currentSelections = [...globalData.volunteers[sid]];
                }
                updateMap();
            });
        }

        function renderMap() {
            const config = globalData.config;
            const map = document.getElementById('seatMap');
            map.innerHTML = '';
            map.style.gridTemplateColumns = `repeat(${config.cols}, auto)`;

            for(let r=0; r<config.rows; r++) {
                for(let c=1; c<=config.cols; c++) {
                    const id = ROW_LETTERS[r] + c;
                    const div = document.createElement('div');
                    div.className = 'seat';
                    div.dataset.id = id;
                    div.textContent = id;
                    
                    if (config.unavailable.includes(id)) {
                        div.className += ' unavailable';
                    } else {
                        div.onclick = () => toggleSeat(id);
                    }
                    map.appendChild(div);
                }
            }
        }

        function toggleSeat(id) {
            const sid = document.getElementById('studentSelect').value;
            if (!sid) return alert("è«‹å…ˆé¸æ“‡åº§è™Ÿ");

            const idx = currentSelections.indexOf(id);
            if (idx === -1) currentSelections.push(id);
            else currentSelections.splice(idx, 1);
            
            updateMap();
        }

        function updateMap() {
            document.querySelectorAll('.seat').forEach(el => {
                el.classList.remove('selected');
                el.textContent = el.dataset.id; // é‡ç½®æ–‡å­—
                const idx = currentSelections.indexOf(el.dataset.id);
                if (idx !== -1) {
                    el.classList.add('selected');
                    el.textContent = idx + 1; // é¡¯ç¤ºå¿—é¡˜åº
                }
            });
        }

        document.getElementById('uploadBtn').onclick = () => {
            const sid = document.getElementById('studentSelect').value;
            if (!sid) return alert("è«‹å…ˆé¸æ“‡åº§è™Ÿ");
            
            const btn = document.getElementById('uploadBtn');
            btn.disabled = true; btn.textContent = "ä¸Šå‚³ä¸­...";

            const formData = new URLSearchParams();
            formData.append(FIELD_STUDENT_ID, sid);
            formData.append(FIELD_VOLUNTEERS, currentSelections.join(','));

            fetch(FORM_ACTION_URL, { method: 'POST', mode: 'no-cors', body: formData })
            .then(() => {
                alert("ä¸Šå‚³æˆåŠŸï¼");
                // æš«æ™‚æ›´æ–°æœ¬åœ°æ•¸æ“šï¼Œè®“ä½¿ç”¨è€…ä¸ç”¨é‡æ•´å°±èƒ½çœ‹åˆ°è®Šæ›´
                if(!globalData.volunteers) globalData.volunteers = {};
                globalData.volunteers[sid] = currentSelections;
            })
            .catch(() => alert("ä¸Šå‚³å¤±æ•—"))
            .finally(() => { btn.disabled = false; btn.textContent = "ä¸Šå‚³å¿—é¡˜"; });
        };
        
        document.getElementById('clearBtn').onclick = () => {
             if(confirm("æ¸…ç©ºç•¶å‰å¿—é¡˜ï¼Ÿ")) {
                 currentSelections = [];
                 updateMap();
             }
        };

        init();
    </script>
</body>
</html>
