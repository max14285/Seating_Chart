<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿå¿—é¡˜é¸å¡«</title>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; padding: 20px; background-color: #f0f2f5; display: flex; flex-direction: column; align-items: center; }
        h1 { color: #333; margin-bottom: 10px; }

        /* --- æ§åˆ¶å€å¡Š --- */
        .controls { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 600px; margin-bottom: 20px; text-align: center; }
        select { padding: 10px; font-size: 16px; border-radius: 6px; border: 1px solid #ddd; width: 60%; margin-bottom: 15px; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-group { display: flex; gap: 10px; justify-content: center; }
        button { padding: 10px 20px; font-size: 16px; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-weight: bold; }
        #uploadBtn { background-color: #007bff; color: white; flex: 2; }
        #uploadBtn:hover:not(:disabled) { background-color: #0056b3; transform: translateY(-1px); }
        #uploadBtn:disabled { background-color: #ccc; cursor: not-allowed; transform: none; }
        #clearBtn { background-color: #dc3545; color: white; flex: 1; }
        #clearBtn:hover { background-color: #a71d2a; }

        /* --- åœ–ä¾‹èªªæ˜ --- */
        .legend { display: flex; gap: 15px; margin-bottom: 15px; font-size: 14px; color: #555; justify-content: center; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 15px; height: 15px; border-radius: 4px; border: 1px solid #ccc; }
        
        /* --- åº§ä½è¡¨å€åŸŸ --- */
        .chart-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow-x: auto; max-width: 100%; display: flex; flex-direction: column; align-items: center; }
        
        /* --- è¬›å°æ¨£å¼ (æ–°å¢) --- */
        .stage-area {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: 30px; /* èˆ‡åº§ä½çš„è·é›¢ */
        }
        .lectern {
            width: 160px;
            height: 45px;
            background-color: #795548; /* æœ¨é ­è‰² */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-weight: bold;
            letter-spacing: 2px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
            font-size: 16px;
            border-bottom: 4px solid #5d4037; /*ç«‹é«”æ„Ÿ*/
        }

        #seatMap { display: grid; gap: 8px; justify-content: center; margin: 0 auto; }

        /* --- åº§ä½æ ¸å¿ƒæ¨£å¼ --- */
        .seat {
            width: 55px; height: 55px;
            background-color: #f8f9fa; /* æœªé¸ï¼šç°ç™½ */
            border: 2px solid #e9ecef;
            color: #495057;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            position: relative;
        }

        /* åº§ä½æ–‡å­— */
        .seat-id { font-size: 12px; color: #adb5bd; margin-top: 2px;}
        .rank { font-size: 18px; font-weight: bold; line-height: 1; }

        /* äº’å‹•æ•ˆæœ */
        .seat:hover:not(.unavailable) {
            border-color: #007bff;
            background-color: #e7f1ff;
        }

        /* --- ç‹€æ…‹ï¼šå·²é¸ --- */
        .seat.selected {
            background-color: #007bff; /* æ·±è—åº• */
            border-color: #0056b3;
            color: white; /* ç™½å­— */
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
            z-index: 1;
        }
        .seat.selected .seat-id { color: rgba(255,255,255,0.7); }

        /* --- ç‹€æ…‹ï¼šä¸å¯é¸ --- */
        .seat.unavailable {
            background-color: #ffebee; 
            border-color: #ffcdd2;
            color: #c62828;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* æç¤º */
        .info-text { margin-top: 20px; font-size: 0.9em; color: #666; background: #e2e3e5; padding: 10px; border-radius: 6px;}

    </style>
</head>
<body>

    <h1>ğŸ“ å¿—é¡˜é¸å¡«ç³»çµ±</h1>

    <div class="controls">
        <label for="studentSelect" style="display:block; margin-bottom:5px; font-weight:bold;">è«‹å…ˆé¸æ“‡æ‚¨çš„åº§è™Ÿï¼š</label>
        <select id="studentSelect">
            <option value="">è³‡æ–™è¼‰å…¥ä¸­...</option>
        </select>

        <div class="legend">
            <div class="legend-item"><div class="dot" style="background:#f8f9fa;"></div> æœªé¸</div>
            <div class="legend-item"><div class="dot" style="background:#007bff;"></div> <strong>å·²é¸ (å¿—é¡˜)</strong></div>
            <div class="legend-item"><div class="dot" style="background:#ffebee;"></div> ä¸å¯å</div>
        </div>

        <div class="btn-group">
            <button id="clearBtn">æ¸…ç©ºé‡é¸</button>
            <button id="uploadBtn">ä¸Šå‚³å¿—é¡˜</button>
        </div>
    </div>

    <div class="chart-container">
        <div class="stage-area">
            <div class="lectern">è¬› å°</div>
        </div>

        <div id="seatMap"></div>
    </div>

    <div class="info-text">
        ğŸ’¡ <strong>æ“ä½œèªªæ˜ï¼š</strong> é»æ“Šåº§ä½å³å¯åŠ å…¥å¿—é¡˜åº (1, 2, 3...)ï¼Œå†æ¬¡é»æ“Šå·²é¸åº§ä½å¯å–æ¶ˆã€‚ç¢ºèªç„¡èª¤å¾Œè«‹æŒ‰ã€Œä¸Šå‚³å¿—é¡˜ã€ã€‚
    </div>

    <script>
        // **********************************************

        // **è«‹æ›¿æ›ç‚ºæ‚¨çš„ Google Form è¨­å®šå€¼**
        const FORM_ACTION_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSfuPbctj-TvBmDtauc2pottDQR_NuFIssn9mUrfInG4DRkeKQ/formResponse'; 
        const FIELD_STUDENT_ID = 'entry.878919355'; 
        const FIELD_VOLUNTEERS = 'entry.1183865171';
        const APPS_SCRIPT_API_URL = 'https://script.google.com/macros/s/AKfycbz1qRFp0IC6RAUJvosl-ACMuCRD42S7mFUFZMp_vtsNs7nLLxhBWXtAfHm_E3E4iccOoA/exec'; // èˆ‡ distribution.html å…±ç”¨
        // **********************************************


        const ROW_LETTERS = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];
        let currentSelections = [];
        let globalData = {}; 

        async function init() {
            const select = document.getElementById('studentSelect');
            try {
                // å¾ Apps Script è®€å– SystemData
                const res = await fetch(APPS_SCRIPT_API_URL);
                const json = await res.json();
                globalData = json.data;

                if (!globalData.students || !globalData.config) {
                    select.innerHTML = '<option>è¨­å®šæª”è®€å–å¤±æ•—</option>';
                    alert("ç„¡æ³•è®€å–è¨­å®šï¼è«‹ç¢ºèª Google Sheet çš„ SystemData åˆ†é ã€‚");
                    return;
                }

                populateSelect();
                renderMap();
            } catch (e) {
                console.error(e);
                select.innerHTML = '<option>é€£ç·šéŒ¯èª¤</option>';
                alert("é€£ç·šéŒ¯èª¤ï¼š" + e.message);
            }
        }

        function populateSelect() {
            const select = document.getElementById('studentSelect');
            select.innerHTML = '<option value="">-- è«‹é¸æ“‡åº§è™Ÿ --</option>';
            
            Object.keys(globalData.students).sort((a,b)=>a-b).forEach(id => {
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = `${id}è™Ÿ - ${globalData.students[id]}`;
                select.appendChild(opt);
            });
            
            select.addEventListener('change', function() {
                const sid = this.value;
                currentSelections = [];
                if (sid && globalData.volunteers && globalData.volunteers[sid]) {
                    currentSelections = [...globalData.volunteers[sid]];
                }
                updateMap(); 
            });
        }

        function renderMap() {
            const config = globalData.config;
            const map = document.getElementById('seatMap');
            map.innerHTML = '';
            map.style.gridTemplateColumns = `repeat(${config.cols}, auto)`;

            for(let r=0; r<config.rows; r++) {
                for(let c=1; c<=config.cols; c++) {
                    const id = ROW_LETTERS[r] + c;
                    const div = document.createElement('div');
                    div.className = 'seat';
                    div.dataset.id = id;
                    
                    div.innerHTML = `
                        <div class="rank"></div>
                        <div class="seat-id">${id}</div>
                    `;
                    
                    if (config.unavailable.includes(id)) {
                        div.className += ' unavailable';
                        div.title = "æ­¤åº§ä½ä¸å¯é¸";
                    } else {
                        div.onclick = () => toggleSeat(id);
                    }
                    map.appendChild(div);
                }
            }
        }

        function toggleSeat(id) {
            const sid = document.getElementById('studentSelect').value;
            if (!sid) {
                alert("âš ï¸ è«‹å…ˆåœ¨ä¸Šæ–¹é¸å–®é¸æ“‡æ‚¨çš„ã€Œåº§è™Ÿã€ï¼");
                document.getElementById('studentSelect').focus();
                return;
            }

            const idx = currentSelections.indexOf(id);
            if (idx === -1) {
                currentSelections.push(id);
            } else {
                currentSelections.splice(idx, 1);
            }
            
            updateMap();
        }

        function updateMap() {
            document.querySelectorAll('.seat').forEach(el => {
                const id = el.dataset.id;
                const rankDiv = el.querySelector('.rank');
                
                el.classList.remove('selected');
                rankDiv.textContent = ''; 

                const idx = currentSelections.indexOf(id);
                if (idx !== -1) {
                    el.classList.add('selected');
                    rankDiv.textContent = idx + 1; 
                }
            });
        }

        document.getElementById('uploadBtn').onclick = () => {
            const sid = document.getElementById('studentSelect').value;
            if (!sid) return alert("è«‹å…ˆé¸æ“‡åº§è™Ÿ");
            
            const btn = document.getElementById('uploadBtn');
            btn.disabled = true; 
            btn.textContent = "è³‡æ–™ä¸Šå‚³ä¸­...";

            const formData = new URLSearchParams();
            formData.append(FIELD_STUDENT_ID, sid);
            formData.append(FIELD_VOLUNTEERS, currentSelections.join(','));

            fetch(FORM_ACTION_URL, { method: 'POST', mode: 'no-cors', body: formData })
            .then(() => {
                const name = globalData.students[sid];
                alert(`âœ… ä¸Šå‚³æˆåŠŸï¼\n${sid}è™Ÿ ${name} å·²æäº¤ ${currentSelections.length} å€‹å¿—é¡˜ã€‚`);
                if(!globalData.volunteers) globalData.volunteers = {};
                globalData.volunteers[sid] = currentSelections;
            })
            .catch((err) => {
                alert("âŒ ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
                console.error(err);
            })
            .finally(() => { 
                btn.disabled = false; 
                btn.textContent = "ä¸Šå‚³å¿—é¡˜"; 
            });
        };
        
        document.getElementById('clearBtn').onclick = () => {
             const sid = document.getElementById('studentSelect').value;
             if (!sid) return alert("è«‹å…ˆé¸æ“‡åº§è™Ÿ");
             
             if(confirm("ç¢ºå®šè¦æ¸…ç©ºç›®å‰é¸å¡«çš„æ‰€æœ‰å¿—é¡˜å—ï¼Ÿ(éœ€å†æ¬¡æŒ‰ä¸Šå‚³æ‰ç®—æ•¸)")) {
                 currentSelections = [];
                 updateMap();
             }
        };

        init();
    </script>
</body>
</html>
