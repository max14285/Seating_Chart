<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿå¿—é¡˜é¸å¡«</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f7f9; }
        h1 { color: #007bff; text-align: center; }
        .controls { background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); margin-bottom: 20px; display: flex; align-items: center; gap: 20px; }
        .controls label { font-weight: bold; }
        .controls select, .controls button { padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 16px; }
        
        #uploadBtn { background-color: #28a745; color: white; border: none; cursor: pointer; transition: background-color 0.3s; }
        #uploadBtn:hover { background-color: #1e7e34; }
        #clearBtn { background-color: #dc3545; color: white; border: none; cursor: pointer; transition: background-color 0.3s; }
        #clearBtn:hover { background-color: #c82333; }

        .seating-chart-container { display: flex; justify-content: center; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        #seatMap { display: grid; gap: 5px; }
        
        .seat { 
            background-color: #007bff; color: white; font-weight: bold; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            height: 60px; width: 60px; border-radius: 6px; cursor: pointer; 
            transition: background-color 0.3s; border: 3px solid transparent; 
            font-size: 14px;
        }
        .seat.unavailable { background-color: #6c757d; cursor: not-allowed; opacity: 0.7; }
        .seat:not(.unavailable):hover { background-color: #0056b3; border-color: #ffc107; }
        
        .seat-id { font-size: 10px; opacity: 0.8; margin-top: 2px; }
        .rank { font-size: 20px; line-height: 1; }
        .seat.selected { border: 3px solid #ffc107; }
    </style>
</head>
<body>

    <h1>ğŸ“ åº§ä½å¿—é¡˜é¸å¡«</h1>

    <div class="controls">
        <label for="studentSelect">è«‹é¸æ“‡æ‚¨çš„åº§è™Ÿï¼š</label>
        <select id="studentSelect">
            <option value="">-- è«‹é¸æ“‡åº§è™Ÿ --</option>
        </select>
        <button id="clearBtn">æ¸…ç©ºå¿—é¡˜</button>
        <button id="uploadBtn">ä¸Šå‚³å¿—é¡˜</button>
    </div>

    <div class="seating-chart-container">
        <div id="seatMap">è¼‰å…¥ä¸­...</div>
    </div>

    <script>
        const ROW_LETTERS = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
        const studentSelect = document.getElementById('studentSelect');
        const seatMapDiv = document.getElementById('seatMap');
        const clearBtn = document.getElementById('clearBtn');
        const uploadBtn = document.getElementById('uploadBtn');

        let currentSelections = []; // ç•¶å‰é¸å¡«çš„å¿—é¡˜åºï¼Œä¾‹å¦‚: ["A1", "C3", "B2"]
        let currentStudentId = null;
        let seatingConfig = null;
        let studentData = null;
        let volunteerData = {}; // æ‰€æœ‰å­¸ç”Ÿçš„å¿—é¡˜çµæœ

        /**
         * è®€å–æ‰€æœ‰æ‰€éœ€çš„æ•¸æ“š (é…ç½®ã€å­¸ç”Ÿåå–®ã€å¿—é¡˜çµæœ)
         */
        function loadData() {
            try {
                // è¼‰å…¥åº§ä½é…ç½®
                const configStr = localStorage.getItem('seating_config');
                if (!configStr) {
                    alert('éŒ¯èª¤ï¼šè«‹å…ˆåœ¨ã€Œè¦æ ¼è¨­å®šé ã€è¨­å®šåº§ä½è¡¨è¦æ ¼ï¼');
                    seatMapDiv.innerHTML = 'è«‹å…ˆè¨­å®šåº§ä½è¡¨è¦æ ¼ã€‚';
                    return false;
                }
                seatingConfig = JSON.parse(configStr);

                // è¼‰å…¥å­¸ç”Ÿåå–®
                const studentStr = localStorage.getItem('student_data');
                studentData = JSON.parse(studentStr);

                // è¼‰å…¥å¿—é¡˜çµæœ
                const volunteerStr = localStorage.getItem('volunteer_data');
                if (volunteerStr) {
                    volunteerData = JSON.parse(volunteerStr);
                }
                
                return true;
            } catch (error) {
                console.error('è¼‰å…¥è³‡æ–™éŒ¯èª¤:', error);
                alert('è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œè«‹ç¢ºèªè¨­å®šæª”æ˜¯å¦æ­£ç¢ºã€‚');
                return false;
            }
        }

        /**
         * å¡«å……å­¸ç”Ÿåº§è™Ÿä¸‹æ‹‰å¼é¸å–®
         */
        function populateStudentSelect() {
            if (!studentData) return;
            // å°‡åº§è™ŸæŒ‰æ•¸å­—æ’åº
            const sortedKeys = Object.keys(studentData).sort((a, b) => parseInt(a) - parseInt(b));
            
            sortedKeys.forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = `${id} è™Ÿ - ${studentData[id]}`;
                studentSelect.appendChild(option);
            });
        }

        /**
         * æ¸²æŸ“åº§ä½è¡¨
         */
        function renderSeatMap() {
            if (!seatingConfig) return;

            seatMapDiv.innerHTML = '';
            seatMapDiv.style.gridTemplateColumns = `repeat(${seatingConfig.cols}, auto)`;

            for (let r = 0; r < seatingConfig.rows; r++) {
                for (let c = 1; c <= seatingConfig.cols; c++) {
                    const seatId = `${ROW_LETTERS[r]}${c}`;
                    const seatEl = document.createElement('div');
                    seatEl.classList.add('seat');
                    seatEl.dataset.id = seatId;
                    
                    // å…§å®¹å€
                    const rankDiv = document.createElement('div');
                    rankDiv.classList.add('rank');
                    rankDiv.textContent = ''; // å¿—é¡˜åº
                    
                    const idDiv = document.createElement('div');
                    idDiv.classList.add('seat-id');
                    idDiv.textContent = seatId; // åº§ä½ ID
                    
                    seatEl.appendChild(rankDiv);
                    seatEl.appendChild(idDiv);


                    if (seatingConfig.unavailable.includes(seatId)) {
                        seatEl.classList.add('unavailable');
                        seatEl.title = 'ä¸å¯é¸åº§ä½';
                        seatMapDiv.appendChild(seatEl);
                        continue; // ä¸å¯é»æ“Š
                    }
                    
                    seatEl.addEventListener('click', handleSeatClick);
                    seatMapDiv.appendChild(seatEl);
                }
            }
        }

        /**
         * æ ¹æ“š currentSelections é‡æ–°ç¹ªè£½å¿—é¡˜åºæ¨™è¨˜
         */
        function updateSeatRanks() {
            document.querySelectorAll('.seat').forEach(seat => {
                const seatId = seat.dataset.id;
                const rankDiv = seat.querySelector('.rank');
                
                // æ¸…ç©ºç‹€æ…‹
                seat.classList.remove('selected');
                rankDiv.textContent = ''; 

                const rankIndex = currentSelections.indexOf(seatId);
                
                if (rankIndex !== -1) {
                    const rank = rankIndex + 1;
                    rankDiv.textContent = rank;
                    seat.classList.add('selected'); // æ¨™è¨˜ç‚ºå·²é¸
                }
            });
        }

        /**
         * è™•ç†åº§ä½é»æ“Šäº‹ä»¶ï¼ˆè¨­å®šå¿—é¡˜åºï¼‰
         * @param {Event} event 
         */
        function handleSeatClick(event) {
            if (!currentStudentId) {
                alert('è«‹å…ˆåœ¨ä¸Šæ–¹ä¸‹æ‹‰å¼é¸å–®é¸æ“‡æ‚¨çš„åº§è™Ÿï¼');
                return;
            }

            const seatEl = event.currentTarget;
            const seatId = seatEl.dataset.id;

            if (seatEl.classList.contains('unavailable')) return;

            const index = currentSelections.indexOf(seatId);

            if (index === -1) {
                // 1. é»æ“Šæ–°åº§ä½ -> æ–°å¢ç‚ºä¸‹ä¸€å¿—é¡˜
                currentSelections.push(seatId);
            } else {
                // 2. é»æ“Šå·²é¸åº§ä½ -> ç§»é™¤è©²å¿—é¡˜ï¼Œå¾ŒçºŒå¿—é¡˜éè£œ
                currentSelections.splice(index, 1);
            }
            
            updateSeatRanks();
        }

        /**
         * è™•ç†å­¸ç”Ÿåº§è™Ÿé¸æ“‡è®ŠåŒ–
         */
        studentSelect.addEventListener('change', function() {
            const selectedId = this.value;
            if (selectedId) {
                currentStudentId = selectedId;
                // è¼‰å…¥è©²å­¸ç”Ÿå·²å„²å­˜çš„å¿—é¡˜
                currentSelections = volunteerData[currentStudentId] ? [...volunteerData[currentStudentId]] : [];
            } else {
                currentStudentId = null;
                currentSelections = [];
            }
            
            updateSeatRanks();
        });

        /**
         * è™•ç†æ¸…ç©ºå¿—é¡˜æŒ‰éˆ•
         */
        clearBtn.addEventListener('click', function() {
            if (!currentStudentId) {
                alert('è«‹å…ˆé¸æ“‡åº§è™Ÿï¼');
                return;
            }
            if (confirm(`ç¢ºå®šè¦æ¸…ç©º ${currentStudentId} è™Ÿçš„å¿—é¡˜å—ï¼Ÿ`)) {
                currentSelections = [];
                updateSeatRanks();
                alert('å¿—é¡˜å·²æ¸…ç©º (å°šæœªå„²å­˜)ï¼');
            }
        });

        /**
         * è™•ç†ä¸Šå‚³å¿—é¡˜æŒ‰éˆ•
         */
        uploadBtn.addEventListener('click', function() {
            if (!currentStudentId) {
                alert('è«‹å…ˆé¸æ“‡åº§è™Ÿï¼');
                return;
            }
            
            if (currentSelections.length === 0) {
                 if (!confirm(`æ‚¨å°šæœªé¸å¡«ä»»ä½•å¿—é¡˜ï¼Œç¢ºå®šè¦å„²å­˜ç©ºçš„å¿—é¡˜å—ï¼Ÿ`)) {
                    return;
                }
            }

            // å„²å­˜åˆ°å¿—é¡˜æ•¸æ“šçµæ§‹ä¸­
            volunteerData[currentStudentId] = currentSelections;
            
            // å„²å­˜åˆ° LocalStorage
            localStorage.setItem('volunteer_data', JSON.stringify(volunteerData));
            
            alert(`${currentStudentId} è™Ÿ ( ${studentData[currentStudentId]} ) çš„ ${currentSelections.length} å€‹å¿—é¡˜å·²æˆåŠŸå„²å­˜ï¼`);
        });

        // åˆå§‹åŒ–
        if (loadData()) {
            populateStudentSelect();
            renderSeatMap();
        }
    </script>
</body>
</html>
