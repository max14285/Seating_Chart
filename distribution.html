<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>座位分發系統</title>
    <style>
         /* 請複製之前的 CSS */
         body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f4f7f9; }
         /* ... */
         #seatMap { display: grid; gap: 5px; margin-top: 20px; }
         .seat { width: 60px; height: 60px; background: #e9ecef; border: 1px solid #ccc; display: flex; flex-direction: column; align-items: center; justify-content: center; }
         .seat.unavailable { background: #6c757d; opacity: 0.7; }
         .seat.distributed { background: #007bff; color: white; }
         .student-id { font-size: 20px; font-weight: bold; }
         .seat-id { font-size: 10px; }
         .sidebar { float:left; width: 250px; background: white; padding: 10px; margin-right: 20px;}
         .chart-area { overflow: hidden; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="sidebar">
            <button id="distributeBtn" style="width:100%; padding:10px;">▶️ 開始分發</button>
            <h3>狀態</h3>
            <div id="statusList">載入中...</div>
        </div>
        <div class="chart-area">
            <div id="seatMap"></div>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_API_URL = 'https://script.google.com/macros/s/AKfycbz1qRFp0IC6RAUJvosl-ACMuCRD42S7mFUFZMp_vtsNs7nLLxhBWXtAfHm_E3E4iccOoA/exec'; // 請填入您的網址
        const ROW_LETTERS = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];
        
        let globalData = {};
        let finalDistribution = {};

        async function init() {
            try {
                const res = await fetch(APPS_SCRIPT_API_URL);
                const json = await res.json();
                globalData = json.data;

                if (!globalData.students || !globalData.config) {
                    alert("資料不完整 (缺名單或設定)，請檢查 Google Sheet SystemData 分頁。");
                    return;
                }
                
                // 載入上次分發結果
                const savedDist = localStorage.getItem('final_distribution');
                if (savedDist) finalDistribution = JSON.parse(savedDist);

                renderStatus();
                renderMap();
                
                document.getElementById('distributeBtn').onclick = startDistribute;

            } catch (e) {
                document.getElementById('statusList').innerHTML = "載入失敗: " + e.message;
            }
        }

        function renderStatus() {
            const list = document.getElementById('statusList');
            list.innerHTML = '';
            Object.keys(globalData.students).sort((a,b)=>a-b).forEach(id => {
                const hasVol = globalData.volunteers[id];
                const div = document.createElement('div');
                div.style.borderBottom = "1px dotted #ccc";
                div.innerHTML = `${id}號 ${globalData.students[id]} : <span style="color:${hasVol?'green':'red'}">${hasVol ? (hasVol.length>0 ? '已填':'隨機') : '未填'}</span>`;
                list.appendChild(div);
            });
        }

        function renderMap() {
            const config = globalData.config;
            const map = document.getElementById('seatMap');
            map.innerHTML = '';
            map.style.gridTemplateColumns = `repeat(${config.cols}, auto)`;

            // 反查表：哪個位置坐誰
            const seatToStudent = {};
            for(let sid in finalDistribution) seatToStudent[finalDistribution[sid]] = sid;

            for(let r=0; r<config.rows; r++) {
                for(let c=1; c<=config.cols; c++) {
                    const id = ROW_LETTERS[r] + c;
                    const div = document.createElement('div');
                    div.className = 'seat';
                    
                    // 顯示學生
                    const sid = seatToStudent[id];
                    div.innerHTML = `<div class="student-id">${sid||''}</div><div class="seat-id">${id}</div>`;

                    if(config.unavailable.includes(id)) div.className += ' unavailable';
                    else if(sid) div.className += ' distributed';
                    
                    div.dataset.id = id;
                    map.appendChild(div);
                }
            }
        }
        
        // 分發邏輯與之前類似，省略部分代碼以節省篇幅，核心是使用 globalData.config 和 globalData.volunteers
        // ... (請將之前成功的 startDistribution 函式貼過來，並將變數名稱替換成 globalData.students 等) ... 
        
        // 簡易版分發實作參考：
        async function startDistribute() {
             // 1. 準備空位
             let seats = [];
             const config = globalData.config;
             for(let r=0; r<config.rows; r++)
                for(let c=1; c<=config.cols; c++) {
                    let id = ROW_LETTERS[r]+c;
                    if(!config.unavailable.includes(id)) seats.push(id);
                }
             
             // 2. 隨機排序學生
             let sids = Object.keys(globalData.students);
             sids.sort(() => Math.random() - 0.5);
             
             finalDistribution = {};
             renderMap(); // 清空畫面

             for(let sid of sids) {
                 let wishes = globalData.volunteers[sid] || [];
                 let assigned = null;
                 
                 // 找志願
                 for(let w of wishes) {
                     let idx = seats.indexOf(w);
                     if(idx !== -1) {
                         assigned = w;
                         seats.splice(idx, 1);
                         break;
                     }
                 }
                 // 沒志願或志願被搶 -> 隨機
                 if(!assigned && seats.length > 0) {
                     let idx = Math.floor(Math.random() * seats.length);
                     assigned = seats[idx];
                     seats.splice(idx, 1);
                 }
                 
                 if(assigned) {
                     finalDistribution[sid] = assigned;
                     // 簡單動畫效果：直接更新該座位
                     let seatEl = document.querySelector(`.seat[data-id="${assigned}"]`);
                     if(seatEl) {
                         seatEl.classList.add('distributed');
                         seatEl.querySelector('.student-id').textContent = sid;
                     }
                     await new Promise(r => setTimeout(r, 1000)); // 1秒一個
                 }
             }
             localStorage.setItem('final_distribution', JSON.stringify(finalDistribution));
             alert("分發完成");
        }

        init();
    </script>
</body>
</html>
