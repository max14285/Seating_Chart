<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº§ä½åˆ†ç™¼ç³»çµ±</title>
    <style>
        /* --- åŸºç¤æ¨£å¼ --- */
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; padding: 20px; background-color: #f4f7f9; display: flex; flex-direction: column; height: 95vh; box-sizing: border-box; }
        h1 { color: #333; text-align: center; margin: 0 0 20px 0; font-size: 24px; }
        
        /* --- ç‰ˆé¢é…ç½® --- */
        .main-container { display: flex; gap: 20px; flex: 1; overflow: hidden; }
        
        /* å´é‚Šæ¬„ (åŠ å¯¬ä»¥å®¹ç´è¡¨æ ¼) */
        .sidebar { 
            width: 400px; 
            background-color: #fff; 
            padding: 15px; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
            display: flex; 
            flex-direction: column; 
            gap: 15px;
        }

        /* å´é‚Šæ¬„å€å¡Šæ¨™é¡Œ */
        h3 { margin: 0 0 10px 0; color: #555; border-bottom: 2px solid #eee; padding-bottom: 5px; font-size: 16px; }

        /* å€å¡Š 1: å­¸ç”Ÿåå–®èˆ‡è¨­å®š (å¯æ²å‹•) */
        .panel-section { flex: 1; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; padding: 5px; }
        
        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; background: #f8f9fa; padding: 5px; position: sticky; top: 0; }
        td { padding: 5px; border-bottom: 1px solid #eee; vertical-align: middle; }
        
        /* è¼¸å…¥æ¡† */
        input.adj-input { width: 40px; padding: 3px; border: 1px solid #ccc; border-radius: 4px; text-align: center; }
        
        /* ç‹€æ…‹æ¨™ç±¤ */
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .tag-filled { background: #e3f2fd; color: #0d47a1; }
        .tag-empty { background: #ffebee; color: #c62828; }
        .tag-random { background: #e0f2f1; color: #00695c; }

        /* å€å¡Š 2: åˆ†ç™¼é †åºåˆ—è¡¨ */
        #orderList { list-style: none; padding: 0; margin: 0; }
        #orderList li { 
            padding: 8px; margin-bottom: 4px; background: #f8f9fa; border-radius: 4px; font-size: 14px; 
            display: flex; justify-content: space-between; border-left: 4px solid transparent;
        }
        #orderList li.active { border-left-color: #ffc107; background: #fff3cd; font-weight: bold; }
        #orderList li.done { border-left-color: #28a745; background: #d4edda; color: #155724; }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn-group { display: flex; gap: 10px; margin-bottom: 5px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s; }
        
        #btnGenerate { background-color: #17a2b8; color: white; }
        #btnGenerate:hover { background-color: #138496; }
        
        #btnStart { background-color: #28a745; color: white; }
        #btnStart:hover:not(:disabled) { background-color: #218838; }
        #btnStart:disabled { background-color: #ccc; cursor: not-allowed; }

        /* --- å³å´åº§ä½è¡¨ --- */
        .chart-area { flex-grow: 1; background-color: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); overflow: auto; display: flex; flex-direction: column; align-items: center; }

        /* è¬›å° */
        .stage-area { width: 100%; display: flex; justify-content: center; margin-bottom: 40px; }
        .lectern { width: 180px; height: 50px; background-color: #795548; color: white; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: bold; letter-spacing: 3px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); border-bottom: 5px solid #5d4037; }

        #seatMap { display: grid; gap: 8px; }
        
        /* åº§ä½æ¨£å¼ */
        .seat { 
            width: 65px; height: 65px; 
            background-color: #f8f9fa; border: 2px solid #e9ecef; color: #495057;
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            border-radius: 8px; transition: all 0.5s; position: relative;
        }
        .seat.unavailable { background-color: #ffebee; border-color: #ffcdd2; opacity: 0.6; }
        
        /* å·²åˆ†ç™¼æ¨£å¼ (æ˜é¡¯è‰²å½©) */
        .seat.distributed { 
            background-color: #007bff; border-color: #0056b3; color: white; 
            transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,123,255,0.3); z-index: 10;
        }
        
        .seat-id { font-size: 10px; margin-top: 2px; opacity: 0.8; }
        .student-id { font-size: 20px; font-weight: bold; line-height: 1; }
    </style>
</head>
<body>

    <h1>ğŸ§‘â€ğŸ« åº§ä½åˆ†ç™¼ç³»çµ±</h1>

    <div class="main-container">
        <div class="sidebar">
            <div class="btn-group">
                <button id="btnGenerate">ğŸ² 1. ç”¢ç”Ÿéš¨æ©Ÿæ•¸èˆ‡é †åº</button>
                <button id="btnStart" disabled>â–¶ï¸ 2. é–‹å§‹åˆ†ç™¼</button>
            </div>

            <div class="panel-section" style="flex: 3;">
                <h3>ğŸ“‹ å­¸ç”Ÿåå–®èˆ‡è¨­å®š (ä¾åº§è™Ÿ)</h3>
                <table>
                    <thead>
                        <tr>
                            <th width="15%">è™Ÿ</th>
                            <th width="25%">å§“å</th>
                            <th width="20%">ç‹€æ…‹</th>
                            <th width="15%">èª¿æ•´</th>
                            <th width="25%">éš¨æ©Ÿ(ç¸½åˆ†)</th>
                        </tr>
                    </thead>
                    <tbody id="studentTableBody">
                        <tr><td colspan="5" align="center">è¼‰å…¥ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="panel-section" style="flex: 2; background-color: #fffbf0;">
                <h3>ğŸ† åˆ†ç™¼é †åº (ä¾é«˜åˆ†æ’åº)</h3>
                <ul id="orderList">
                    <li style="color:#999; text-align:center;">è«‹å…ˆé»æ“Šã€Œç”¢ç”Ÿéš¨æ©Ÿæ•¸ã€</li>
                </ul>
            </div>
        </div>

        <div class="chart-area">
            <div class="stage-area">
                <div class="lectern">è¬› å°</div>
            </div>
            <div id="seatMap">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <script>
        // **********************************************
        // ğŸ”¹ è«‹å¡«å…¥æ‚¨çš„ Apps Script URL ğŸ”¹
        const APPS_SCRIPT_API_URL = 'https://script.google.com/macros/s/AKfycbz1qRFp0IC6RAUJvosl-ACMuCRD42S7mFUFZMp_vtsNs7nLLxhBWXtAfHm_E3E4iccOoA/exec'; // è«‹å¡«å…¥æ‚¨çš„ç¶²å€
        // **********************************************

        const ROW_LETTERS = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];
        
        // å…¨åŸŸè®Šæ•¸
        let globalData = {}; // å­˜æ”¾ API å›å‚³çš„å®Œæ•´è³‡æ–™
        let adjustments = {}; // å­˜æ”¾æ‰‹å‹•èª¿æ•´çš„åˆ†æ•¸ { studentId: score }
        let distributionOrder = []; // æœ€çµ‚æ’åºå¾Œçš„å­¸ç”Ÿ ID é™£åˆ—
        let availableSeats = []; // ç›®å‰å¯ç”¨çš„åº§ä½
        let finalDistribution = {}; // æœ€çµ‚çµæœ

        // åˆå§‹åŒ–
        async function init() {
            try {
                // 1. è¼‰å…¥è³‡æ–™
                const res = await fetch(APPS_SCRIPT_API_URL);
                const json = await res.json();
                globalData = json.data;

                if (!globalData.students || !globalData.config) {
                    alert("è³‡æ–™ä¸å®Œæ•´ï¼Œè«‹æª¢æŸ¥ Google Sheet SystemData è¨­å®šã€‚");
                    return;
                }

                // 2. æ¸²æŸ“ç•«é¢
                renderStudentTable();
                renderSeatMap();

                // 3. ç¶å®šæŒ‰éˆ•
                document.getElementById('btnGenerate').onclick = generateOrder;
                document.getElementById('btnStart').onclick = startDistribution;

            } catch (e) {
                console.error(e);
                alert("è¼‰å…¥å¤±æ•—: " + e.message);
            }
        }

        // æ¸²æŸ“å·¦ä¸Šè§’å­¸ç”Ÿåˆ—è¡¨ (åŒ…å«èª¿æ•´è¼¸å…¥æ¡†)
        function renderStudentTable() {
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = '';
            
            const sortedIds = Object.keys(globalData.students).sort((a,b)=>a-b);

            sortedIds.forEach(id => {
                const name = globalData.students[id];
                const wishes = globalData.volunteers[id];
                
                // åˆ¤æ–·ç‹€æ…‹
                let statusBadge = '<span class="tag tag-empty">æœªå¡«</span>';
                if (wishes) {
                    statusBadge = wishes.length > 0 
                        ? `<span class="tag tag-filled">å·²å¡«</span>`
                        : `<span class="tag tag-random">éš¨æ©Ÿ</span>`;
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${id}</td>
                    <td>${name}</td>
                    <td>${statusBadge}</td>
                    <td><input type="number" class="adj-input" data-id="${id}" value="0"></td>
                    <td class="score-cell" id="score-${id}">-</td>
                `;
                tbody.appendChild(tr);
            });

            // ç¶å®šè¼¸å…¥æ¡†äº‹ä»¶
            document.querySelectorAll('.adj-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const id = e.target.dataset.id;
                    adjustments[id] = parseInt(e.target.value) || 0;
                });
            });
        }

        // æ¸²æŸ“å³å´åº§ä½è¡¨
        function renderSeatMap() {
            const config = globalData.config;
            const map = document.getElementById('seatMap');
            map.innerHTML = '';
            map.style.gridTemplateColumns = `repeat(${config.cols}, auto)`;

            availableSeats = [];

            for(let r=0; r<config.rows; r++) {
                for(let c=1; c<=config.cols; c++) {
                    const id = ROW_LETTERS[r] + c;
                    const div = document.createElement('div');
                    div.className = 'seat';
                    div.innerHTML = `<div class="student-id"></div><div class="seat-id">${id}</div>`;
                    div.dataset.id = id;

                    if(config.unavailable.includes(id)) {
                        div.className += ' unavailable';
                    } else {
                        availableSeats.push(id); // æ”¶é›†å¯ç”¨åº§ä½
                    }
                    map.appendChild(div);
                }
            }
        }

        // æ­¥é©Ÿ 1: ç”¢ç”Ÿéš¨æ©Ÿæ•¸èˆ‡é †åº
        function generateOrder() {
            distributionOrder = [];
            const studentIds = Object.keys(globalData.students);
            const scoreList = [];

            // è¨ˆç®—åˆ†æ•¸
            studentIds.forEach(id => {
                const baseScore = Math.floor(Math.random() * 100); // 0-99 éš¨æ©Ÿæ•¸
                const adj = adjustments[id] || 0;
                const totalScore = baseScore + adj;

                // æ›´æ–°è¡¨æ ¼é¡¯ç¤º: 85 (+5)
                const cell = document.getElementById(`score-${id}`);
                if(cell) {
                    const sign = adj >= 0 ? '+' : '';
                    cell.innerHTML = `<b>${totalScore}</b> <span style="color:#888;font-size:10px;">(${baseScore}${sign}${adj})</span>`;
                }

                scoreList.push({ id, totalScore });
            });

            // æ’åº (é«˜åˆ†åœ¨å‰)
            scoreList.sort((a, b) => b.totalScore - a.totalScore);
            distributionOrder = scoreList.map(item => item.id);

            // æ›´æ–°å·¦ä¸‹è§’é †åºåˆ—è¡¨
            renderOrderList(scoreList);

            // å•Ÿç”¨é–‹å§‹åˆ†ç™¼æŒ‰éˆ•
            document.getElementById('btnStart').disabled = false;
            alert("éš¨æ©Ÿæ•¸å·²ç”¢ç”Ÿï¼è«‹ç¢ºèªé †åºç„¡èª¤å¾Œï¼ŒæŒ‰ä¸‹ã€Œé–‹å§‹åˆ†ç™¼ã€ã€‚");
        }

        function renderOrderList(scoreList) {
            const ul = document.getElementById('orderList');
            ul.innerHTML = '';
            scoreList.forEach((item, index) => {
                const name = globalData.students[item.id];
                const li = document.createElement('li');
                li.id = `order-${item.id}`;
                li.innerHTML = `
                    <span>#${index+1} <b>${item.id}è™Ÿ</b> ${name}</span>
                    <span>${item.totalScore}åˆ†</span>
                `;
                ul.appendChild(li);
            });
        }

        // æ­¥é©Ÿ 2: é–‹å§‹åˆ†ç™¼
        async function startDistribution() {
            document.getElementById('btnStart').disabled = true;
            document.getElementById('btnGenerate').disabled = true;
            
            // é‡ç½®åº§ä½ç‹€æ…‹
            renderSeatMap(); 
            finalDistribution = {};
            let currentAvailable = [...availableSeats];

            for (const sid of distributionOrder) {
                // æ¨™è¨˜ç›®å‰æ­£åœ¨åˆ†ç™¼çš„å­¸ç”Ÿ
                const li = document.getElementById(`order-${sid}`);
                if(li) {
                    li.scrollIntoView({ behavior: "smooth", block: "center" });
                    li.classList.add('active');
                }

                let assignedSeat = null;
                const wishes = globalData.volunteers[sid] || []; // å–å¾—å¿—é¡˜ (å¯èƒ½æ˜¯ç©ºé™£åˆ—)

                // ç­–ç•¥ 1: æª¢æŸ¥å¿—é¡˜
                for (const seat of wishes) {
                    const idx = currentAvailable.indexOf(seat);
                    if (idx !== -1) {
                        assignedSeat = seat;
                        currentAvailable.splice(idx, 1);
                        break;
                    }
                }

                // ç­–ç•¥ 2: ç„¡å¿—é¡˜æˆ–å¿—é¡˜è¢«æ¶ -> éš¨æ©Ÿåˆ†é…
                if (!assignedSeat) {
                    if (currentAvailable.length > 0) {
                        const randIdx = Math.floor(Math.random() * currentAvailable.length);
                        assignedSeat = currentAvailable[randIdx];
                        currentAvailable.splice(randIdx, 1);
                    } else {
                        console.warn(`å­¸ç”Ÿ ${sid} ç„¡ä½å¯åï¼`);
                    }
                }

                // åŸ·è¡Œåˆ†ç™¼å‹•ç•«
                if (assignedSeat) {
                    finalDistribution[sid] = assignedSeat;
                    const seatEl = document.querySelector(`.seat[data-id="${assignedSeat}"]`);
                    if (seatEl) {
                        seatEl.classList.add('distributed');
                        seatEl.querySelector('.student-id').textContent = sid;
                    }
                }

                // æ›´æ–°åˆ—è¡¨ç‹€æ…‹
                if(li) {
                    li.classList.remove('active');
                    li.classList.add('done');
                    li.innerHTML += ` &rarr; <b>${assignedSeat || 'X'}</b>`;
                }

                // æš«åœ 1.5 ç§’è®“è€å¸«çœ‹æ¸…æ¥š
                await new Promise(r => setTimeout(r, 1500));
            }

            alert("ğŸ‰ å…¨éƒ¨åˆ†ç™¼å®Œç•¢ï¼");
            // å¯é¸æ“‡æ˜¯å¦é–‹å•Ÿé‡ç½®æŒ‰éˆ•
            // document.getElementById('btnGenerate').disabled = false;
        }

        init();
    </script>
</body>
</html>
