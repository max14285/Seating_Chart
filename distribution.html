<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº§ä½åˆ†ç™¼ç³»çµ± - ç¬¬ä¸‰æ®µç¨‹å¼</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f7f9; }
        h1 { color: #007bff; text-align: center; }
        
        .main-container { display: flex; gap: 20px; margin-top: 20px; }
        .sidebar { width: 250px; background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .chart-area { flex-grow: 1; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }

        /* åˆ†ç™¼æŒ‰éˆ• */
        #distributeBtn { 
            padding: 12px 25px; background-color: #ffc107; color: #333; 
            border: none; border-radius: 4px; cursor: pointer; font-size: 18px; 
            font-weight: bold; width: 100%; margin-bottom: 20px; 
            transition: background-color 0.3s;
        }
        #distributeBtn:hover:not(:disabled) { background-color: #e0a800; }
        #distributeBtn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* å­¸ç”Ÿåˆ—è¡¨ */
        .student-list-item { padding: 5px 0; border-bottom: 1px dotted #eee; display: flex; justify-content: space-between; font-size: 14px; }
        .status-filled { color: #28a745; font-weight: bold; }
        .status-empty { color: #dc3545; }

        /* åˆ†ç™¼é †åº */
        #distributionOrder { margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; }
        #orderList { display: flex; flex-wrap: wrap; gap: 5px; list-style: none; padding: 0; margin: 0; }
        #orderList li { padding: 4px 8px; background-color: #f8f9fa; border: 1px solid #ddd; border-radius: 3px; font-size: 14px; transition: background-color 0.5s; }
        #orderList li.current-student { background-color: #ffc107; font-weight: bold; border-color: #ffaa00; }
        #orderList li.distributed { background-color: #28a745; color: white; }
        
        /* åº§ä½è¡¨ */
        #seatMap { display: grid; gap: 5px; margin-top: 20px; }
        .seat { 
            background-color: #e9ecef; color: #333; font-weight: bold; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            height: 70px; border-radius: 6px; border: 1px solid #ccc; 
            transition: background-color 0.5s, border-color 0.5s;
            font-size: 14px;
        }
        .seat.unavailable { background-color: #6c757d; color: white; opacity: 0.7; }
        .seat.distributed { background-color: #007bff; color: white; border-color: #ffc107; }
        .seat-id { font-size: 10px; opacity: 0.8; margin-top: 2px; }
        .student-id { font-size: 24px; line-height: 1; }
    </style>
</head>
<body>

    <h1>ğŸ§‘â€ğŸ« åº§ä½åˆ†ç™¼ç³»çµ±</h1>

    <div class="main-container">
        <div class="sidebar">
            <button id="distributeBtn">â–¶ï¸ é–‹å§‹åˆ†ç™¼åº§ä½</button>

            <h3>å­¸ç”Ÿé¸å¡«ç‹€æ…‹</h3>
            <div id="studentStatusList">è¼‰å…¥ä¸­...</div>

            <div id="distributionOrder">
                <h3>åˆ†ç™¼é †åº</h3>
                <ul id="orderList"></ul>
            </div>
        </div>

        <div class="chart-area">
            <h2>åº§ä½è¡¨</h2>
            <div id="seatMap">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <script>
        const ROW_LETTERS = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
        const studentStatusListDiv = document.getElementById('studentStatusList');
        const distributeBtn = document.getElementById('distributeBtn');
        const orderListUl = document.getElementById('orderList');
        const seatMapDiv = document.getElementById('seatMap');

        let seatingConfig = null;
        let studentData = null;
        let volunteerData = {};
        let finalDistribution = {}; 
        let availableSeats = []; 

        /**
         * è®€å–æ‰€æœ‰æ‰€éœ€çš„æ•¸æ“š (å¾ config.json å’Œ volunteers.json è®€å–)
         */
        async function loadData() {
            try {
                // è¼‰å…¥å­¸ç”Ÿåå–® (å¾ LocalStorage è®€å–)
                const studentStr = localStorage.getItem('student_data');
                if (!studentStr) throw new Error('å­¸ç”Ÿåå–®æœªè¼‰å…¥ï¼Œè«‹å…ˆé‹è¡Œ setting.html');
                studentData = JSON.parse(studentStr);

                // å¾ config.json æª”æ¡ˆè¼‰å…¥åº§ä½é…ç½®
                const configResponse = await fetch('config.json');
                if (!configResponse.ok) throw new Error('config.json æª”æ¡ˆä¸å­˜åœ¨æˆ–ç„¡æ³•è®€å–ã€‚è«‹å…ˆåœ¨ setting.html å„²å­˜é…ç½®ã€‚');
                seatingConfig = await configResponse.json();

                // å¾ volunteers.json æª”æ¡ˆè¼‰å…¥å¿—é¡˜çµæœ
                const volunteerResponse = await fetch('volunteers.json');
                if (volunteerResponse.ok && volunteerResponse.status !== 204) {
                    const text = await volunteerResponse.text();
                    volunteerData = text ? JSON.parse(text) : {}; 
                } else {
                    volunteerData = {}; 
                }

                // å¾ LocalStorage è¼‰å…¥æœ€çµ‚åˆ†ç™¼çµæœ (åˆ†ç™¼å¾Œå„²å­˜æ–¼æ­¤ï¼Œæ–¹ä¾¿é‡æ•´é é¢)
                const finalDistributionStr = localStorage.getItem('final_distribution');
                if (finalDistributionStr) {
                    finalDistribution = JSON.parse(finalDistributionStr);
                }
                
                // è¨ˆç®—å¯é¸åº§ä½
                availableSeats = [];
                for (let r = 0; r < seatingConfig.rows; r++) {
                    for (let c = 1; c <= seatingConfig.cols; c++) {
                        const seatId = `${ROW_LETTERS[r]}${c}`;
                        if (!seatingConfig.unavailable.includes(seatId)) {
                            availableSeats.push(seatId);
                        }
                    }
                }

                return true;
            } catch (error) {
                console.error('è¼‰å…¥è³‡æ–™éŒ¯èª¤:', error);
                alert(`è¼‰å…¥è³‡æ–™å¤±æ•—ï¼š${error.message}`);
                seatMapDiv.innerHTML = `è¼‰å…¥éŒ¯èª¤ï¼š${error.message}`;
                return false;
            }
        }

        /**
         * æ¸²æŸ“å­¸ç”Ÿé¸å¡«ç‹€æ…‹åˆ—è¡¨
         */
        function renderStudentStatus() {
            studentStatusListDiv.innerHTML = '';
            const studentIds = Object.keys(studentData).sort((a, b) => parseInt(a) - parseInt(b));

            studentIds.forEach(id => {
                const name = studentData[id];
                const selections = volunteerData[id] || [];
                const isFilled = selections.length > 0;
                
                const item = document.createElement('div');
                item.classList.add('student-list-item');
                item.innerHTML = `
                    <span>${id} è™Ÿ ${name}</span>
                    <span class="${isFilled ? 'status-filled' : 'status-empty'}">
                        ${isFilled ? `å·²å¡« (${selections.length})` : 'æœªå¡«'}
                    </span>
                `;
                studentStatusListDiv.appendChild(item);
            });
        }

        /**
         * æ¸²æŸ“åº§ä½è¡¨ (é¡¯ç¤ºæœ€çµ‚åˆ†ç™¼çµæœæˆ–ç©ºç™½)
         */
        function renderSeatMap() {
            if (!seatingConfig) return;

            seatMapDiv.innerHTML = '';
            seatMapDiv.style.gridTemplateColumns = `repeat(${seatingConfig.cols}, auto)`;

            // åè½‰ finalDistribution æ–¹ä¾¿æŸ¥æ‰¾å­¸ç”Ÿåº§è™Ÿ
            const studentToSeat = {};
            for (const seatId in finalDistribution) {
                const studentId = finalDistribution[seatId];
                studentToSeat[studentId] = seatId;
            }

            for (let r = 0; r < seatingConfig.rows; r++) {
                for (let c = 1; c <= seatingConfig.cols; c++) {
                    const seatId = `${ROW_LETTERS[r]}${c}`;
                    const seatEl = document.createElement('div');
                    seatEl.classList.add('seat');
                    
                    // æ‰¾å‡ºå“ªå€‹å­¸ç”Ÿçš„åº§ä½æ˜¯é€™å€‹
                    const studentId = Object.keys(studentToSeat).find(id => studentToSeat[id] === seatId);

                    seatEl.innerHTML = `
                        <div class="student-id">${finalDistribution[seatId] || ''}</div>
                        <div class="seat-id">${seatId}</div>
                    `;

                    if (seatingConfig.unavailable.includes(seatId)) {
                        seatEl.classList.add('unavailable');
                    } else if (finalDistribution[seatId]) {
                        seatEl.classList.add('distributed');
                    }
                    
                    seatEl.dataset.id = seatId;
                    seatMapDiv.appendChild(seatEl);
                }
            }
        }

        /**
         * ç”¢ç”Ÿéš¨æ©Ÿåˆ†ç™¼é †åº
         */
        function generateRandomOrder() {
            const studentIds = Object.keys(studentData);
            // Fisher-Yates Shuffle æ¼”ç®—æ³•
            for (let i = studentIds.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [studentIds[i], studentIds[j]] = [studentIds[j], studentIds[i]];
            }
            return studentIds;
        }

        /**
         * åŸ·è¡Œåˆ†ç™¼æµç¨‹
         */
        async function startDistribution() {
            distributeBtn.disabled = true;
            finalDistribution = {}; // æ¸…ç©ºä¸Šä¸€æ¬¡çš„åˆ†ç™¼çµæœ
            orderListUl.innerHTML = '';
            renderSeatMap(); // é¡¯ç¤ºç©ºç™½åº§ä½è¡¨
            
            let currentAvailableSeats = [...availableSeats]; 

            const distributionOrder = generateRandomOrder();
            let orderListItems = {}; 

            // 1. é¡¯ç¤ºéš¨æ©Ÿåˆ†ç™¼é †åº
            distributionOrder.forEach(id => {
                const name = studentData[id];
                const li = document.createElement('li');
                li.textContent = `${id} è™Ÿ ${name}`;
                li.dataset.id = id;
                orderListUl.appendChild(li);
                orderListItems[id] = li;
            });

            // 2. ä¾åºåˆ†ç™¼
            for (let i = 0; i < distributionOrder.length; i++) {
                const studentId = distributionOrder[i];
                const studentVolunteers = volunteerData[studentId] || [];
                orderListItems[studentId].classList.add('current-student');
                
                let assignedSeat = null;

                // 2a. å˜—è©¦ä¾å¿—é¡˜åºåˆ†ç™¼
                for (let j = 0; j < studentVolunteers.length; j++) {
                    const wishSeat = studentVolunteers[j];
                    const index = currentAvailableSeats.indexOf(wishSeat);
                    
                    if (index !== -1) {
                        // å¿—é¡˜åº§ä½å¯ç”¨
                        assignedSeat = wishSeat;
                        currentAvailableSeats.splice(index, 1); // ç§»é™¤æ­¤åº§ä½
                        break;
                    }
                }
                
                // 2b. è‹¥å¿—é¡˜æœªé¸æ»¿æˆ–é¸ä¸åˆ°ï¼Œå‰‡éš¨æ©Ÿåˆ†ç™¼å‰©é¤˜åº§ä½
                if (!assignedSeat) {
                    if (currentAvailableSeats.length > 0) {
                        const randomIndex = Math.floor(Math.random() * currentAvailableSeats.length);
                        assignedSeat = currentAvailableSeats[randomIndex];
                        currentAvailableSeats.splice(randomIndex, 1); 
                    } else {
                        console.warn(`å­¸ç”Ÿ ${studentId} ç„¡æ³•åˆ†ç™¼åˆ°åº§ä½ï¼`);
                        continue;
                    }
                }

                // 3. åŸ·è¡Œåˆ†ç™¼
                finalDistribution[assignedSeat] = studentId;
                
                // 4. ç•«é¢æ›´æ–°
                const seatEl = document.querySelector(`.seat[data-id="${assignedSeat}"]`);
                if (seatEl) {
                    seatEl.classList.add('distributed');
                    seatEl.querySelector('.student-id').textContent = studentId;
                }
                
                // 5. é †åºåˆ—è¡¨æ›´æ–°
                orderListItems[studentId].classList.remove('current-student');
                orderListItems[studentId].classList.add('distributed');

                // æš«åœ 2 ç§’
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
            
            // 6. åˆ†ç™¼å®Œæˆï¼Œå„²å­˜çµæœåˆ° LocalStorage
            localStorage.setItem('final_distribution', JSON.stringify(finalDistribution));
            alert('åº§ä½å·²å…¨éƒ¨åˆ†ç™¼å®Œç•¢ï¼çµæœå·²å„²å­˜æ–¼ç€è¦½å™¨ã€‚');
            distributeBtn.disabled = false;
        }

        // åˆå§‹åŒ–
        (async function() {
            if (await loadData()) {
                renderStudentStatus();
                renderSeatMap();
                distributeBtn.addEventListener('click', startDistribution);
            } else {
                distributeBtn.disabled = true;
            }
        })();
    </script>
</body>
</html>
